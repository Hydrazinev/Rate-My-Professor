<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Professor Chatbot</title>

  <style>
    :root{
      --bg1:#0b0c10;--bg2:#1f2833;--panel:#1b1e23;--panel-2:#20242b;
      --header:#21252b;--ink:#c5c6c7;--border:#2a2e35;--accent:#66fcf1;
    }
    html,body{height:100%}
    body{margin:0;display:grid;place-items:center;background:linear-gradient(135deg,var(--bg1),var(--bg2));font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;color:var(--ink)}

    .chat{width:min(100%,520px);height:min(90vh,720px);background:var(--panel);border-radius:16px;display:grid;grid-template-rows:auto auto 1fr auto;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.45)}

    header{background:var(--header);padding:8px 12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border)}
    header h1{margin:0;font-size:1.15rem;line-height:1.2;font-weight:700}
    .status{width:10px;height:10px;border-radius:50%}
    .status--connected{background:#06ff06}.status--connecting{background:#fffb4d}.status--disconnected{background:#ff3434}

    nav{display:flex;gap:8px;flex-wrap:wrap;background:var(--panel-2);border-bottom:1px solid var(--border);padding:8px 10px}
    .qa-btn{display:flex;align-items:center;gap:8px;background:#262b33;border:1px solid #323845;padding:8px 10px;border-radius:10px;color:#e9eff2;cursor:pointer;font-size:.92rem}
    .qa-dot{width:6px;height:6px;border-radius:50%;background:var(--accent)}

    main{display:flex;flex-direction:column;min-height:0}
    #messages{list-style:none;margin:0;padding:14px;display:flex;flex-direction:column;gap:10px;overflow:auto;min-height:0}
    .bubble{padding:12px 16px;border-radius:18px;line-height:1.45;font-size:.95rem;max-width:100%}
    .bubble--user{background:#39424e;color:#fff;align-self:flex-end}
    .bubble--ai{background:#2d313a;color:var(--ink)}

    form.chat__composer{background:var(--header);padding:10px 12px;border-top:1px solid var(--border);display:grid;grid-template-columns:1fr auto;gap:10px}
    .composer__input{padding:10px 14px;border-radius:12px;background:#2a2f37;border:1px solid #3c4350;color:#e0e4ea}
    .composer__send{width:44px;height:44px;border-radius:12px;border:1px solid #2e333c;background:#3a4150;color:#fff;cursor:pointer;display:grid;place-items:center}

    .loader{display:flex;gap:12px;align-items:center;background:#2d313a;padding:12px 16px;border-radius:18px}
    .loader__spinner{width:18px;height:18px;border-radius:50%;border:2px solid #818897;border-top-color:transparent;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .loader__content{flex:1}.loader__line{height:8px;background:#3b414d;border-radius:6px;margin:5px 0}
    .loader__line--long{width:75%}.loader__line--med{width:55%}.loader__line--short{width:35%}
    .loader__status{display:flex;align-items:center;gap:4px;font-size:.85rem;color:#aeb3bd}
    .loader__dot{width:4px;height:4px;border-radius:50%;background:#aeb3bd;animation:bounce 1.3s infinite}
    .loader__dot:nth-child(2){animation-delay:.15s}.loader__dot:nth-child(3){animation-delay:.3s}
    @keyframes bounce{0%,80%,100%{opacity:.35;transform:translateY(0)}40%{opacity:1;transform:translateY(-3px)}}

    .cards{display:grid;gap:10px}
    .card{background:#222731;border:1px solid #313745;border-radius:14px;padding:12px}
    .card h3{margin:0}.meta{display:flex;justify-content:space-between;flex-wrap:wrap;color:#c9ced6;font-size:.9rem}
    .chips{display:flex;gap:6px;flex-wrap:wrap}.chip{background:#2f3542;border:1px solid #3b414d;padding:2px 8px;border-radius:999px}
    .rating{display:flex;align-items:center;gap:10px}.stars{font-size:1.05rem}.badge{background:#26323a;border:1px solid #3b414d;padding:2px 8px;border-radius:999px;font-size:.85rem}

    dialog{border:none;border-radius:16px;background:#1b1f26;color:var(--ink);padding:16px;width:min(92vw,520px);max-height:78vh;overflow:auto}
    dialog::backdrop{background:rgba(0,0,0,.45)}
    .dialog__title{margin:0 0 6px 0;font-size:1.05rem}
    .dialog__desc{margin:0 0 12px 0;color:#aeb3bd}
    .field{display:grid;gap:6px;margin:10px 0}
    .field input{padding:10px 12px;border-radius:10px;border:1px solid #323845;background:#262c36;color:#e0e4ea}
    .dialog__actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    .btn{padding:10px 12px;border-radius:10px;border:1px solid #343a46;background:#2a303a;color:#e4e9ee;cursor:pointer}
    .btn--primary{background:#315665;border-color:#3a6a7b}
    .dialog__close{position:absolute;top:10px;right:10px;width:32px;height:32px;border-radius:8px;border:1px solid #3b414d;background:#2e333c;color:#fff;cursor:pointer}

    @media (max-width:480px){ dialog{width:94vw;max-height:82vh} }
  </style>
</head>
<body>
  <div class="chat" data-ws-url="">
    <header>
      <h1>Professor Chatbot</h1>
      <span id="connStatus" class="status status--disconnected"></span>
    </header>

    <nav>
      <button class="qa-btn" id="openByName"><span class="qa-dot"></span><span>Search Professor by name.</span></button>
      <button class="qa-btn" id="openByUni"><span class="qa-dot"></span><span>Search Professor by university.</span></button>
    </nav>

    <main>
      <ul id="messages">
        <li class="bubble bubble--ai">Welcome! Choose an option above, or type a query (e.g., <em>Find professor "Todd Farchione" at Harvard</em>).</li>
      </ul>
    </main>

    <form id="composerForm" class="chat__composer">
      <input id="composerInput" class="composer__input" placeholder="Type a message…" autocomplete="off" />
      <button class="composer__send" type="submit">
        <svg width="18" height="18" viewBox="0 0 24 24"><path d="M2,21 L23,12 L2,3 L2,10 L17,12 L2,14 Z" fill="#fff"/></svg>
      </button>
    </form>
  </div>

  <dialog id="dlgName">
    <button class="dialog__close" type="button" data-close="dlgName">×</button>
    <h2 class="dialog__title">Search Professor by Name</h2>
    <p class="dialog__desc">Enter a professor’s name. Optionally include a university.</p>
    <form id="dlgNameForm" method="dialog">
      <div class="field"><label for="nm_name">Professor name *</label><input id="nm_name" required /></div>
      <div class="field"><label for="nm_school">University (optional)</label><input id="nm_school" /></div>
      <div class="dialog__actions">
        <button class="btn" type="button" data-close="dlgName">Cancel</button>
        <button class="btn btn--primary" type="submit">Search</button>
      </div>
    </form>
  </dialog>

  <dialog id="dlgUni">
    <button class="dialog__close" type="button" data-close="dlgUni">×</button>
    <h2 class="dialog__title">Search Professor by University</h2>
    <p class="dialog__desc">Enter the university. Optionally filter by a name fragment.</p>
    <form id="dlgUniForm" method="dialog">
      <div class="field"><label for="un_school">University *</label><input id="un_school" required /></div>
      <div class="field"><label for="un_filter">Name filter (optional)</label><input id="un_filter" /></div>
      <div class="dialog__actions">
        <button class="btn" type="button" data-close="dlgUni">Cancel</button>
        <button class="btn btn--primary" type="submit">Search</button>
      </div>
    </form>
  </dialog>

  <script>
    const $=(s,r=document)=>r.querySelector(s),$$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const log=$("#messages"),form=$("#composerForm"),input=$("#composerInput"),status=$("#connStatus");
    const dlgName=$("#dlgName"),dlgUni=$("#dlgUni"),nmName=$("#nm_name"),nmSchool=$("#nm_school"),unSchool=$("#un_school"),unFilter=$("#un_filter");
    $("#openByName").onclick=()=>{dlgName.showModal();setTimeout(()=>nmName.focus(),0)};
    $("#openByUni").onclick =()=>{dlgUni.showModal();setTimeout(()=>unSchool.focus(),0)};
    $$('[data-close="dlgName"]').forEach(b=>b.onclick=()=>dlgName.close());
    $$('[data-close="dlgUni"]').forEach(b=>b.onclick=()=>dlgUni.close());
    [dlgName,dlgUni].forEach(d=>d.addEventListener("click",e=>{if(e.target===d)d.close()}));

    function setStatus(s){status.className="status "+(s==="connected"?"status--connected":s==="connecting"?"status--connecting":"status--disconnected");}
    function pushUser(t){const li=document.createElement("li");li.className="bubble bubble--user";li.textContent=t;log.append(li);log.scrollTop=log.scrollHeight;}
    function pushAI(h){const li=document.createElement("li");li.className="bubble bubble--ai";li.innerHTML=h;log.append(li);log.scrollTop=log.scrollHeight;}
    function pushLoader(){const li=document.createElement("li");li.className="loader";li.innerHTML='<div class="loader__spinner"></div><div class="loader__content"><div class="loader__line loader__line--long"></div><div class="loader__line loader__line--med"></div><div class="loader__line loader__line--short"></div><div class="loader__status"><span>Thinking</span><span class="loader__dot"></span><span class="loader__dot"></span><span class="loader__dot"></span></div></div>';log.append(li);log.scrollTop=log.scrollHeight;return li;}
    function md(s){return String(s||"").replace(/\r/g,"").replace(/\n/g,"<br>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>");}

    function tryParseRMP(raw){const t=String(raw||"").trim();const re=/(?:^|\n)\s*(?:\d+\.\s*)?(?:\*\*)?([^*\n-]+?)(?:\*\*)?\s*-\s*(?:\*\*Department:\*\*|Department:)\s*([^-\n]+?)\s*-\s*(?:\*\*School:\*\*|School:)\s*([^-\n]+?)\s*-\s*(?:\*\*City:\*\*|City:)\s*([^-\n]+?)\s*-\s*(?:\*\*Average Rating:\*\*|Average Rating:)\s*([0-9.]+)\s*\((\d+)\s*ratings?\)\s*-\s*(?:\*\*Would Take Again:\*\*|Would Take Again:)\s*([0-9]{1,3}%)/gi;let m,out=[];while((m=re.exec(t))){out.push({name:m[1],department:m[2],school:m[3],city:m[4],rating:+m[5],ratingsCount:+m[6],wouldAgain:m[7]});}return out.length?out:null;}
    function renderCards(items){const MAX=5,vis=items.slice(0,MAX),hid=items.slice(MAX);const card=it=>`<article class="card"><h3>${it.name}</h3><div class="meta"><div>${it.school} • ${it.city}</div><div class="chips"><span class="chip">${it.department}</span><span class="chip">${it.ratingsCount} ratings</span></div></div><div class="rating"><span class="stars">${"★".repeat(Math.round(it.rating))+"☆".repeat(5-Math.round(it.rating))}</span><span class="badge">Would take again: ${it.wouldAgain}</span></div></article>`;if(!hid.length)return`<div class="cards">${vis.map(card).join("")}</div>`;const id="more-"+Math.random().toString(36).slice(2,8);return`<div class="cards">${vis.map(card).join("")}</div><details id="${id}" style="margin-top:8px"><summary style="cursor:pointer">Show ${hid.length} more</summary><div class="cards">${hid.map(card).join("")}</div></details>`;}

    let ws=null,streaming=false,buf="",node=null,pending=null;
    const wsUrl=(location.protocol==="https:"?"wss":"ws")+"://"+location.host+"/ws";
    function connect(){setStatus("connecting");try{ws&&ws.close()}catch{};ws=new WebSocket(wsUrl);ws.onopen=()=>setStatus("connected");ws.onerror=()=>setStatus("disconnected");ws.onclose=()=>{setStatus("disconnected");setTimeout(connect,2000)};ws.onmessage=e=>{const d=String(e.data||"").trim();if(d=="<STREAM>"){streaming=true;buf="";node=pending||pushLoader();pending=null;return}if(d=="<END>"){const p=tryParseRMP(buf.trim());node.className="bubble bubble--ai";node.innerHTML=p?renderCards(p):md(buf);streaming=false;buf="";node=null;return}if(streaming){buf+=e.data;return}if(pending){const p=tryParseRMP(d);pending.className="bubble bubble--ai";pending.innerHTML=p?renderCards(p):md(e.data);pending=null;return}const p=tryParseRMP(d);pushAI(p?renderCards(p):md(e.data));};}
    form.addEventListener("submit",e=>{e.preventDefault();const t=input.value.trim();if(!t)return;pushUser(t);pending=pushLoader();if(ws&&ws.readyState===1)ws.send(t);else{setTimeout(()=>{if(pending){pending.className="bubble bubble--ai";pending.innerHTML="⚠️ Disconnected.";pending=null}},400);connect()}input.value=""});
    $("#dlgNameForm").addEventListener("submit",e=>{e.preventDefault();if(!nmName.reportValidity())return;const q=nmSchool.value?`Find professor "${nmName.value}" at ${nmSchool.value}`:`Find professor "${nmName.value}"`;dlgName.close();pushUser(q);pending=pushLoader();if(ws&&ws.readyState===1)ws.send(q);else{connect()}nmName.value="";nmSchool.value=""});
    $("#dlgUniForm").addEventListener("submit",e=>{e.preventDefault();if(!unSchool.reportValidity())return;const q=unFilter.value?`Find professors at ${unSchool.value} named ${unFilter.value}`:`Find professors at ${unSchool.value}`;dlgUni.close();pushUser(q);pending=pushLoader();if(ws&&ws.readyState===1)ws.send(q);else{connect()}unSchool.value="";unFilter.value=""});
    connect();
  </script>
</body>
</html>
